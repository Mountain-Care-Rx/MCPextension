(()=>{var r=typeof browser<"u"?browser:chrome,c=["crmplus_headerBarVisible","crmplus_autoCopyPhone","crmplus_automationEnabled"];function l(o){if(r.runtime.requestUpdateCheck)console.log("[CRM Extension] Checking for updates..."),r.runtime.requestUpdateCheck(function(e,t){console.log("[CRM Extension] Update check status:",e);let s=new Date,i={timestamp:s.getTime(),formattedTime:s.toLocaleString(),status:e,success:e!=="error"};r.storage.local.set({crmplus_lastUpdateCheck:i},function(){r.runtime.lastError?console.error("[CRM Extension] Error saving update check data:",r.runtime.lastError):console.log("[CRM Extension] Saved update check data:",i)});let a={success:!0,message:"Update check completed",updateStatus:e,lastCheck:i};e==="update_available"&&(console.log("[CRM Extension] Update available, version:",t.version),a.updateVersion=t.version),o&&typeof o=="function"&&o(a)});else{console.log("[CRM Extension] Update checking not supported");let e=new Date,t={timestamp:e.getTime(),formattedTime:e.toLocaleString(),status:"not_supported",success:!1};r.storage.local.set({crmplus_lastUpdateCheck:t}),o&&typeof o=="function"&&o({success:!1,message:"Update checking not supported",updateStatus:"error",lastCheck:t})}}l();var u=2*60*60*1e3;setInterval(l,u);r.runtime.onMessage.addListener((o,e,t)=>{if(console.log("Background script received message:",o),o.action==="toggleHeaderVisibility")return r.tabs.query({active:!0,currentWindow:!0},s=>{if(s&&s.length>0)return r.tabs.sendMessage(s[0].id,{action:"toggleHeaderVisibility",isVisible:o.isVisible},i=>{r.runtime.lastError?(console.error("Error sending message:",r.runtime.lastError),t({success:!1,error:r.runtime.lastError.message})):(console.log("Received response from content script:",i),t(i))}),!0;t({success:!1,error:"No active tab found"})}),!0;if(o.action==="syncSettings")return g(t),!0;if(o.action==="loadSettings")return d(t),!0;if(o.action==="checkForUpdates")return l(s=>{console.log("[CRM Extension] Update check result:",s),t(s)}),!0;if(o.action==="getLastUpdateCheck")return r.storage.local.get("crmplus_lastUpdateCheck",s=>{r.runtime.lastError?(console.error("[CRM Extension] Error retrieving last update check:",r.runtime.lastError),t({success:!1,error:r.runtime.lastError.message})):(console.log("[CRM Extension] Retrieved last update check:",s.crmplus_lastUpdateCheck),t({success:!0,lastUpdateCheck:s.crmplus_lastUpdateCheck||null}))}),!0});function n(o){r.tabs.query({url:["*://app.mtncarerx.com/*contacts*","*://app.mtncarerx.com/*conversations*"]},e=>{if(!e||e.length===0){console.log("No matching tabs found for visibility update");return}console.log(`Applying toolbar visibility ${o} to ${e.length} tabs`),e.forEach(t=>{t.url&&t.url.includes("app.mtncarerx.com")&&(t.url.includes("contacts")||t.url.includes("conversations"))&&r.tabs.sendMessage(t.id,{action:"toggleHeaderVisibility",isVisible:o}).catch(s=>{console.log(`Could not update tab ${t.id}, might not be fully loaded`)})})})}function g(o){try{let e={};c.forEach(t=>{let s=localStorage.getItem(t);s!==null&&(e[t]=s==="true")}),console.log("Syncing settings to browser storage:",e),r.storage.local.set(e,()=>{r.runtime.lastError?(console.error("Error syncing settings:",r.runtime.lastError),o&&o({success:!1,error:r.runtime.lastError.message})):(console.log("Settings synced from localStorage to browser storage:",e),"crmplus_headerBarVisible"in e&&n(e.crmplus_headerBarVisible),o&&o({success:!0,settings:e}))})}catch(e){console.error("Error in syncSettingsFromLocalStorage:",e),o&&o({success:!1,error:e.message})}}function d(o){try{r.storage.local.get(c,e=>{if(r.runtime.lastError){console.error("Error loading settings:",r.runtime.lastError),o&&o({success:!1,error:r.runtime.lastError.message});return}console.log("Loaded settings from browser storage:",e),Object.keys(e).forEach(t=>{localStorage.setItem(t,e[t].toString())}),console.log("Settings loaded from browser storage to localStorage:",e),o&&o({success:!0,settings:e})})}catch(e){console.error("Error in loadSettingsToLocalStorage:",e),o&&o({success:!1,error:e.message})}}r.runtime.onInstalled.addListener(o=>{if(o.reason==="install"){console.log("CRM+ Extension installed");let e={crmplus_headerBarVisible:!0,crmplus_autoCopyPhone:!1,crmplus_automationEnabled:!0};console.log("Setting initial default settings:",e),r.storage.local.set(e,()=>{console.log("Default settings initialized:",e),n(!0)})}else o.reason==="update"&&(console.log("CRM+ Extension updated to version",r.runtime.getManifest().version),r.storage.local.get(c,e=>{let t={};e.crmplus_headerBarVisible===void 0&&(t.crmplus_headerBarVisible=!0),e.crmplus_autoCopyPhone===void 0&&(t.crmplus_autoCopyPhone=!1),e.crmplus_automationEnabled===void 0&&(t.crmplus_automationEnabled=!0),Object.keys(t).length>0&&(console.log("Updating missing settings:",t),r.storage.local.set(t,()=>{console.log("Missing settings initialized during update:",t),"crmplus_headerBarVisible"in t&&n(t.crmplus_headerBarVisible)}))}))});r.runtime.onStartup.addListener(()=>{console.log("Browser started, initializing CRM+ Extension"),l(),r.storage.local.get("crmplus_headerBarVisible",o=>{let e=o.crmplus_headerBarVisible!==!1;console.log(`Toolbar visibility on startup: ${e}`),n(e)})});r.tabs.onUpdated.addListener((o,e,t)=>{e.status==="complete"&&t.url&&t.url.includes("app.mtncarerx.com")&&(t.url.includes("contacts")||t.url.includes("conversations"))&&(console.log(`Tab ${o} fully loaded, applying visibility setting`),r.storage.local.get("crmplus_headerBarVisible",s=>{let i=s.crmplus_headerBarVisible!==!1;console.log(`Applying toolbar visibility ${i} to tab ${o}`),r.tabs.sendMessage(o,{action:"toggleHeaderVisibility",isVisible:i}).catch(a=>{console.log(`Could not update tab ${o}, might not be fully loaded`)})}))});})();
